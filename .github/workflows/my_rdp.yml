name: GNOME RDP
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # استعمال الكود اللي صلحناه باش ما يوقعش Error فـ Tailscale
          sudo tailscale up --authkey=$TS_KEY

      - name: Install GNOME Desktop and XRDP
        run: |
          sudo apt-get update
          # تثبيت GNOME مع المكونات الضرورية باش ما تطلعش الشاشة السوداء
          sudo apt-get install -y ubuntu-desktop-minimal xrdp xorgxrdp
          
          # إعداد السيستيم باش يخدم GNOME فـ RDP أوتوماتيكياً
          echo "gnome-session" > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create RDP User and Set Password
        run: |
          # صاوبنا يوزر سميتو rdp ومودباس rdp123 مع صلاحيات كاملة
          sudo useradd -m rdp
          echo "rdp:rdp123" | sudo chpasswd
          sudo adduser rdp sudo
          
          # تأكيد الواجهة لليوزر rdp باش ما يطلعش ليك Error ديال Failsafe Session
          echo "gnome-session" | sudo tee /home/rdp/.xsession
          sudo chown rdp:rdp /home/rdp/.xsession

      - name: Keep Alive (6 Hours)
        run: |
          echo "GNOME RDP is Ready!"
          echo "IP: Search in your Tailscale App"
          echo "User: rdp"
          echo "Pass: rdp123"
          sleep 21600
