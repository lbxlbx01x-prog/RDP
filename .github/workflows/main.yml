name: WINDOWS

on: 
  workflow_dispatch:

jobs:
  windows-hidden:
    runs-on: windows-latest
    
    steps:
      # 1. ØªØ§Ù†ØµØ·Ø§Ù„ÙŠÙˆ Tailscale Ø¨Ø§Ù„Ø³ÙƒØ§Øª (Silent)
      - name: â¬‡ï¸ Install Tailscale (Silent)
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          choco install tailscale -y --no-progress

      # 2. ÙƒÙ†Ø®Ø¯Ù…Ùˆ Tailscale Ø¨ÙˆØ¶Ø¹ÙŠØ© Unattended (Ù…Ø§ÙƒÙŠØ­ØªØ§Ø¬Ø´ ÙˆØ§Ø¬Ù‡Ø©)
      # Ù‡Ø§Ø¯Ø´ÙŠ ÙƒÙŠØ®Ù„ÙŠÙ‡ ÙŠØ®Ø¯Ù… ÙˆØ§Ø®Ø§ ØªØ³Ø¯ Ø§Ù„Ù€ RDP ÙˆØªØ¹Ø§ÙˆØ¯ ØªØ±Ø¬Ø¹
      - name: ğŸ”Œ Connect Tailscale (Background Service)
        run: |
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="github-hidden-vps" --unattended --force-reauth

      # 3. ÙƒÙ†Ù‚Ø§Ø¯Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
      - name: ğŸ› ï¸ Configure User & Firewall
        run: |
          # Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨ØªÙŠ ÙŠØ¨Ù‚Ù‰
          net user runneradmin "Maroc@2026!"
          
          # ØªÙØ¹ÙŠÙ„ RDP ÙØ§Ù„Ø±ÙŠØ¬ÙŠØ³ØªØ±ÙŠ
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          
          # ÙØªØ­ Ø§Ù„Ø¨ÙˆØ± ÙÙ€ Firewall Ø¨Ø§Ø´ ÙŠØ¯ÙˆØ²
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          Write-Host "Configuration Done."

      # 4. ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      - name: â„¹ï¸ Login Details
        run: |
          Write-Host "=========================================="
          Write-Host "âœ… Server is running in background mode."
          Write-Host "Username: runneradmin"
          Write-Host "Password: Maroc@2026!"
          Write-Host "=========================================="

      # 5. Ø§Ù„Ø³Ø§Ø±ÙˆØª Ø¨Ø§Ø´ ÙŠØ¨Ù‚Ù‰ Ø´Ø§Ø¹Ù„ (Ù‡Ø§Ø¯ Ø§Ù„ÙƒÙˆÙ…ÙˆÙ†Ø¯ ÙƒØªØ®Ø¯Ù… ÙØ§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø§Ø´ÙŠ ÙØ§Ù„Ø´Ø§Ø´Ø©)
      - name: â³ Keep Alive (6 Hours)
        run: |
          Write-Host "Session active. You can close RDP and reconnect freely."
          Start-Sleep -Seconds 21600
