name: Windows

on: 
  workflow_dispatch:

jobs:
  windows-session:
    runs-on: windows-latest
    
    steps:
      # 1. ØªÙ†Ø²ÙŠÙ„ ÙˆØªØ³Ø·ÙŠØ¨ Tailscale ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø­ÙŠØª Ø§Ù„Ø£ÙƒØ´Ù† Ù…ÙƒØªØ®Ø¯Ù…Ø´ ÙØ§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²)
      - name: â¬‡ï¸ Install Tailscale
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          choco install tailscale -y

      # 2. ØªÙØ¹ÙŠÙ„ Tailscale ÙˆØ§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø³Ø§Ø±ÙˆØª
      - name: ğŸ”Œ Connect to Tailscale
        run: |
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="github-windows-server" --unattended

      # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆØ²Ø± ÙˆÙØªØ­ RDP
      - name: ğŸ› ï¸ Setup User & Enable RDP
        run: |
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
          net user runneradmin "Maroc@2024!"
          
          # ØªÙØ¹ÙŠÙ„ RDP ÙØ§Ù„Ø±ÙŠØ¬ÙŠØ³ØªØ±ÙŠ
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          
          # ÙØªØ­ Ø§Ù„Ø¨ÙˆØ± ÙÙ€ Firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          Write-Host "RDP Setup Complete."

      # 4. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
      - name: â„¹ï¸ Connection Info
        run: |
          Write-Host "=========================================="
          Write-Host "Go to your Tailscale Admin Console to get the IP"
          Write-Host "Username: rdp"
          Write-Host "Password: rdp123"
          Write-Host "=========================================="

      # 5. Ø¨Ø§Ø´ ÙŠØ¨Ù‚Ù‰ Ø´Ø§Ø¹Ù„ 6 Ø³ÙˆØ§ÙŠØ¹
      - name: â³ Keep Alive (6 Hours)
        run: |
          Write-Host "Session is running..."
          Start-Sleep -Seconds 21600
